{"version":3,"sources":["../src/hooks/useDevices.ts"],"sourcesContent":["import type {\n  StreamPermissionsError,\n  CustomMediaDevice,\n} from '@huddle01/web-core/types';\n\nimport { useEffect, useState } from 'react';\n\nimport useHuddle01 from './useHuddle01';\n\ninterface Props {\n  type: CustomMediaDevice;\n  onPermissionGranted?: () => void;\n  onPermissionDenied?: () => void;\n  onDeviceChanged?: (deviceId: string) => void;\n}\n\nexport const useDevices = (props: Props) => {\n  const { type } = props;\n\n  const { huddleClient } = useHuddle01();\n\n  const localPeer = huddleClient.localPeer;\n\n  const deviceHandler = localPeer.deviceHandler;\n\n  const [devices, setDevices] = useState<MediaDeviceInfo[]>([]);\n\n  const [preferredDeviceId, setPreferredDeviceId] = useState<string | null>(\n    deviceHandler.preferredDevices.get(type) || null,\n  );\n\n  const fetchDevices = (shouldFetchStream = false) => {\n    return deviceHandler.getMediaDevices(type, shouldFetchStream);\n  };\n\n  const handlePermissionGranted = (data: {\n    deviceKind: CustomMediaDevice;\n  }) => {\n    if (data.deviceKind === type) {\n      props.onPermissionGranted?.();\n    }\n  };\n\n  const handlePermissionDenied = (data: {\n    deviceKind: CustomMediaDevice;\n    error: StreamPermissionsError;\n  }) => {\n    if (data.deviceKind === type) {\n      props.onPermissionDenied?.();\n    }\n  };\n\n  const handleDeviceChange = () => {\n    fetchDevices().then((devices) => {\n      setDevices(devices);\n    });\n  };\n\n  const handlePrefferedDeviceChange = (data: {\n    deviceKind: CustomMediaDevice;\n    deviceId: string | null;\n  }) => {\n    if (data.deviceKind === type) {\n      setPreferredDeviceId(data.deviceId);\n    }\n    if (data.deviceId && props?.onDeviceChanged) {\n      props.onDeviceChanged(data.deviceId);\n    }\n  };\n\n  useEffect(() => {\n    deviceHandler.once('permission-granted', handlePermissionGranted);\n\n    deviceHandler.once('permission-denied', handlePermissionDenied);\n\n    deviceHandler.on('device-change', handleDeviceChange);\n\n    deviceHandler.on('preferred-device-change', handlePrefferedDeviceChange);\n\n    if (devices.length === 0) {\n      fetchDevices(false).then((devices) => {\n        setDevices(devices);\n      });\n    }\n\n    return () => {\n      deviceHandler.off('permission-granted', handlePermissionGranted);\n\n      deviceHandler.off('permission-denied', handlePermissionDenied);\n\n      deviceHandler.off('device-change', handleDeviceChange);\n\n      deviceHandler.off('preferred-device-change', handlePrefferedDeviceChange);\n    };\n  }, []);\n\n  const getPermission = () => {\n    return deviceHandler.getMediaPermission({ mediaDeviceKind: type });\n  };\n\n  const fetchStream = deviceHandler.fetchStream;\n\n  const setPreferredDevice = (deviceId: string) => {\n    return deviceHandler.setPreferredDevice({\n      deviceKind: type,\n      deviceId,\n    });\n  };\n\n  const preferredDevice =\n    devices.find((device) => device.deviceId === preferredDeviceId) || null;\n\n  return {\n    devices,\n    preferredDeviceId,\n    preferredDevice,\n    fetchStream,\n    getPermission,\n    setPreferredDevice,\n  };\n};\n"],"mappings":";;;;;AAKA,SAAS,WAAW,gBAAgB;AAW7B,IAAM,aAAa,CAAC,UAAiB;AAC1C,QAAM,EAAE,KAAK,IAAI;AAEjB,QAAM,EAAE,aAAa,IAAI,oBAAY;AAErC,QAAM,YAAY,aAAa;AAE/B,QAAM,gBAAgB,UAAU;AAEhC,QAAM,CAAC,SAAS,UAAU,IAAI,SAA4B,CAAC,CAAC;AAE5D,QAAM,CAAC,mBAAmB,oBAAoB,IAAI;AAAA,IAChD,cAAc,iBAAiB,IAAI,IAAI,KAAK;AAAA,EAC9C;AAEA,QAAM,eAAe,CAAC,oBAAoB,UAAU;AAClD,WAAO,cAAc,gBAAgB,MAAM,iBAAiB;AAAA,EAC9D;AAEA,QAAM,0BAA0B,CAAC,SAE3B;AACJ,QAAI,KAAK,eAAe,MAAM;AAC5B,YAAM,sBAAsB;AAAA,IAC9B;AAAA,EACF;AAEA,QAAM,yBAAyB,CAAC,SAG1B;AACJ,QAAI,KAAK,eAAe,MAAM;AAC5B,YAAM,qBAAqB;AAAA,IAC7B;AAAA,EACF;AAEA,QAAM,qBAAqB,MAAM;AAC/B,iBAAa,EAAE,KAAK,CAACA,aAAY;AAC/B,iBAAWA,QAAO;AAAA,IACpB,CAAC;AAAA,EACH;AAEA,QAAM,8BAA8B,CAAC,SAG/B;AACJ,QAAI,KAAK,eAAe,MAAM;AAC5B,2BAAqB,KAAK,QAAQ;AAAA,IACpC;AACA,QAAI,KAAK,YAAY,OAAO,iBAAiB;AAC3C,YAAM,gBAAgB,KAAK,QAAQ;AAAA,IACrC;AAAA,EACF;AAEA,YAAU,MAAM;AACd,kBAAc,KAAK,sBAAsB,uBAAuB;AAEhE,kBAAc,KAAK,qBAAqB,sBAAsB;AAE9D,kBAAc,GAAG,iBAAiB,kBAAkB;AAEpD,kBAAc,GAAG,2BAA2B,2BAA2B;AAEvE,QAAI,QAAQ,WAAW,GAAG;AACxB,mBAAa,KAAK,EAAE,KAAK,CAACA,aAAY;AACpC,mBAAWA,QAAO;AAAA,MACpB,CAAC;AAAA,IACH;AAEA,WAAO,MAAM;AACX,oBAAc,IAAI,sBAAsB,uBAAuB;AAE/D,oBAAc,IAAI,qBAAqB,sBAAsB;AAE7D,oBAAc,IAAI,iBAAiB,kBAAkB;AAErD,oBAAc,IAAI,2BAA2B,2BAA2B;AAAA,IAC1E;AAAA,EACF,GAAG,CAAC,CAAC;AAEL,QAAM,gBAAgB,MAAM;AAC1B,WAAO,cAAc,mBAAmB,EAAE,iBAAiB,KAAK,CAAC;AAAA,EACnE;AAEA,QAAM,cAAc,cAAc;AAElC,QAAM,qBAAqB,CAAC,aAAqB;AAC/C,WAAO,cAAc,mBAAmB;AAAA,MACtC,YAAY;AAAA,MACZ;AAAA,IACF,CAAC;AAAA,EACH;AAEA,QAAM,kBACJ,QAAQ,KAAK,CAAC,WAAW,OAAO,aAAa,iBAAiB,KAAK;AAErE,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;","names":["devices"]}